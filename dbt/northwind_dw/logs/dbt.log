[0m17:11:25.483796 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343b6ea9ad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343b6d64690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343b6bab5d0>]}


============================== 17:11:25.488127 | a9a8e1f0-01e5-4142-890a-05afc8319966 ==============================
[0m17:11:25.488127 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:11:25.488597 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/opt/airflow/dbt', 'debug': 'False', 'fail_fast': 'False', 'log_path': '/opt/airflow/dbt/northwind_dw/logs', 'warn_error': 'None', 'version_check': 'True', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'static_parser': 'True', 'invocation_command': 'dbt run --select gold_customer_analytics --profiles-dir /opt/airflow/dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:11:26.151736 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a9a8e1f0-01e5-4142-890a-05afc8319966', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x734376f78bd0>]}
[0m17:11:26.211668 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a9a8e1f0-01e5-4142-890a-05afc8319966', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x73437738a310>]}
[0m17:11:26.212368 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:11:26.219790 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:11:26.243880 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:11:26.244319 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:11:26.249278 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a9a8e1f0-01e5-4142-890a-05afc8319966', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343770e76d0>]}
[0m17:11:26.263570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a9a8e1f0-01e5-4142-890a-05afc8319966', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x734376bafb10>]}
[0m17:11:26.264081 [info ] [MainThread]: Found 20 models, 22 tests, 8 sources, 0 exposures, 0 metrics, 562 macros, 0 groups, 0 semantic models
[0m17:11:26.264459 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9a8e1f0-01e5-4142-890a-05afc8319966', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x734376dcb790>]}
[0m17:11:26.265750 [info ] [MainThread]: 
[0m17:11:26.266386 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:11:26.267458 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811'
[0m17:11:26.267862 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:11:27.350745 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_portifolio-482811, now list_portifolio-482811_northwind_bronze)
[0m17:11:27.351615 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_gold'
[0m17:11:27.352691 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_gold'
[0m17:11:27.353500 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_silver'
[0m17:11:27.353968 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:11:27.354297 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:11:27.354611 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:11:27.354900 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:11:28.375862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9a8e1f0-01e5-4142-890a-05afc8319966', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343b6bce750>]}
[0m17:11:28.376645 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:11:28.377008 [info ] [MainThread]: 
[0m17:11:28.384432 [debug] [Thread-1 (]: Began running node model.northwind_dw.gold_customer_analytics
[0m17:11:28.384902 [info ] [Thread-1 (]: 1 of 1 START sql table model gold.gold_customer_analytics ...................... [RUN]
[0m17:11:28.385433 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_portifolio-482811_northwind_bronze, now model.northwind_dw.gold_customer_analytics)
[0m17:11:28.385754 [debug] [Thread-1 (]: Began compiling node model.northwind_dw.gold_customer_analytics
[0m17:11:28.390767 [debug] [Thread-1 (]: Writing injected SQL for node "model.northwind_dw.gold_customer_analytics"
[0m17:11:28.391398 [debug] [Thread-1 (]: Timing info for model.northwind_dw.gold_customer_analytics (compile): 17:11:28.385923 => 17:11:28.391153
[0m17:11:28.391691 [debug] [Thread-1 (]: Began executing node model.northwind_dw.gold_customer_analytics
[0m17:11:28.420715 [debug] [Thread-1 (]: Writing runtime sql for node "model.northwind_dw.gold_customer_analytics"
[0m17:11:28.421314 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:11:28.450348 [debug] [Thread-1 (]: On model.northwind_dw.gold_customer_analytics: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "node_id": "model.northwind_dw.gold_customer_analytics"} */

  
    

    create or replace table `portifolio-482811`.`gold`.`gold_customer_analytics`
      
    
    

    OPTIONS()
    as (
      -- Gold layer: Customer analytics and segmentation


WITH customer_metrics AS (
    SELECT
        c.customer_id,
        c.company_name,
        c.contact_name,
        c.city,
        c.country,
        COUNT(DISTINCT o.order_id) AS total_orders,
        SUM(o.order_total) AS total_spent,
        AVG(o.order_total) AS avg_order_value,
        SUM(o.total_quantity) AS total_items_purchased,
        SUM(o.total_discount_amount) AS total_discounts_received,
        MIN(o.order_date) AS first_order_date,
        MAX(o.order_date) AS last_order_date,
        DATE_DIFF(CURRENT_DATE(), MAX(o.order_date), DAY) AS days_since_last_order
    FROM `portifolio-482811`.`northwind_silver`.`silver_dim_customers` c
    LEFT JOIN `portifolio-482811`.`northwind_silver`.`silver_fact_orders` o ON c.customer_id = o.customer_id
    GROUP BY 
        c.customer_id,
        c.company_name,
        c.contact_name,
        c.city,
        c.country
)

SELECT
    customer_id,
    company_name,
    contact_name,
    city,
    country,
    total_orders,
    ROUND(total_spent, 2) AS total_spent,
    ROUND(avg_order_value, 2) AS avg_order_value,
    total_items_purchased,
    ROUND(total_discounts_received, 2) AS total_discounts_received,
    first_order_date,
    last_order_date,
    days_since_last_order,
    -- Customer segmentation
    CASE 
        WHEN total_orders >= 10 THEN 'VIP'
        WHEN total_orders >= 5 THEN 'Frequent'
        WHEN total_orders >= 2 THEN 'Regular'
        ELSE 'New'
    END AS customer_segment,
    CASE 
        WHEN days_since_last_order <= 30 THEN 'Active'
        WHEN days_since_last_order <= 90 THEN 'At Risk'
        ELSE 'Inactive'
    END AS activity_status,
    CURRENT_TIMESTAMP() AS updated_at
FROM customer_metrics
ORDER BY total_spent DESC
    );
  
[0m17:11:29.488317 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:999a359f-6a8e-4577-8652-5423305eb503&page=queryresults
[0m17:11:30.024317 [debug] [Thread-1 (]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name order_total not found inside o at [24:15]')
[0m17:11:31.271853 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:6876b6e4-6822-4fb3-a4c4-4461cf729349&page=queryresults
[0m17:11:31.747687 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:6876b6e4-6822-4fb3-a4c4-4461cf729349&page=queryresults
[0m17:11:31.750108 [debug] [Thread-1 (]: Timing info for model.northwind_dw.gold_customer_analytics (execute): 17:11:28.391877 => 17:11:31.749592
[0m17:11:31.759184 [debug] [Thread-1 (]: Database Error in model gold_customer_analytics (models/gold/gold_customer_analytics.sql)
  Name order_total not found inside o at [24:15]
  compiled Code at target/run/northwind_dw/models/gold/gold_customer_analytics.sql
[0m17:11:31.760120 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a9a8e1f0-01e5-4142-890a-05afc8319966', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x734376a983d0>]}
[0m17:11:31.760767 [error] [Thread-1 (]: 1 of 1 ERROR creating sql table model gold.gold_customer_analytics ............. [[31mERROR[0m in 3.37s]
[0m17:11:31.761254 [debug] [Thread-1 (]: Finished running node model.northwind_dw.gold_customer_analytics
[0m17:11:31.763640 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:11:31.763942 [debug] [MainThread]: Connection 'model.northwind_dw.gold_customer_analytics' was properly closed.
[0m17:11:31.764158 [debug] [MainThread]: Connection 'list_portifolio-482811_northwind_gold' was properly closed.
[0m17:11:31.764353 [debug] [MainThread]: Connection 'list_portifolio-482811_gold' was properly closed.
[0m17:11:31.764541 [debug] [MainThread]: Connection 'list_portifolio-482811_northwind_silver' was properly closed.
[0m17:11:31.764775 [info ] [MainThread]: 
[0m17:11:31.765112 [info ] [MainThread]: Finished running 1 table model in 0 hours 0 minutes and 5.50 seconds (5.50s).
[0m17:11:31.765517 [debug] [MainThread]: Command end result
[0m17:11:31.774576 [info ] [MainThread]: 
[0m17:11:31.774910 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m17:11:31.775161 [info ] [MainThread]: 
[0m17:11:31.775803 [error] [MainThread]:   Database Error in model gold_customer_analytics (models/gold/gold_customer_analytics.sql)
  Name order_total not found inside o at [24:15]
  compiled Code at target/run/northwind_dw/models/gold/gold_customer_analytics.sql
[0m17:11:31.776361 [info ] [MainThread]: 
[0m17:11:31.776855 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m17:11:31.777828 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 6.3209257, "process_user_time": 3.24729, "process_kernel_time": 1.530421, "process_mem_max_rss": "235916", "process_out_blocks": "2832", "command_success": false, "process_in_blocks": "0"}
[0m17:11:31.778687 [debug] [MainThread]: Command `dbt run` failed at 17:11:31.778476 after 6.32 seconds
[0m17:11:31.779168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343b6eab4d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343b6d66250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7343b6d66450>]}
[0m17:11:31.779458 [debug] [MainThread]: Flushing usage events
[0m17:13:27.381472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86fd89ac90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86fd893090>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86fd890250>]}


============================== 17:13:27.385643 | 03d47351-58e0-4bf8-88ed-fc7580df30a1 ==============================
[0m17:13:27.385643 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:13:27.386078 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'log_path': '/opt/airflow/dbt/northwind_dw/logs', 'fail_fast': 'False', 'profiles_dir': '/opt/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select gold_customer_analytics gold_sales_by_country gold_sales_by_category --profiles-dir /opt/airflow/dbt --full-refresh', 'log_format': 'default', 'introspect': 'True', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:13:28.087222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86be09a4d0>]}
[0m17:13:28.148849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86fd8dbd50>]}
[0m17:13:28.149522 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:13:28.157876 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:13:28.187420 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m17:13:28.188250 [debug] [MainThread]: Partial parsing: updated file: northwind_dw://models/gold/gold_customer_analytics.sql
[0m17:13:28.188804 [debug] [MainThread]: Partial parsing: updated file: northwind_dw://models/gold/gold_sales_by_country.sql
[0m17:13:28.189315 [debug] [MainThread]: Partial parsing: updated file: northwind_dw://models/gold/gold_sales_by_category.sql
[0m17:13:28.358298 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bdcf8e90>]}
[0m17:13:28.372751 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bc0730d0>]}
[0m17:13:28.373908 [info ] [MainThread]: Found 20 models, 22 tests, 8 sources, 0 exposures, 0 metrics, 562 macros, 0 groups, 0 semantic models
[0m17:13:28.374499 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bda4d1d0>]}
[0m17:13:28.379326 [info ] [MainThread]: 
[0m17:13:28.380429 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:13:28.381635 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811'
[0m17:13:28.382091 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:13:29.244954 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_portifolio-482811, now list_portifolio-482811_gold)
[0m17:13:29.245374 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:13:29.246349 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_gold'
[0m17:13:29.247884 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:13:29.250378 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_bronze'
[0m17:13:29.252416 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_silver'
[0m17:13:29.253290 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:13:29.253719 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:13:30.296304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86f91ebb50>]}
[0m17:13:30.297014 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:13:30.297339 [info ] [MainThread]: 
[0m17:13:30.303053 [debug] [Thread-1 (]: Began running node model.northwind_dw.gold_customer_analytics
[0m17:13:30.303457 [debug] [Thread-2 (]: Began running node model.northwind_dw.gold_sales_by_category
[0m17:13:30.303952 [debug] [Thread-3 (]: Began running node model.northwind_dw.gold_sales_by_country
[0m17:13:30.304344 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.gold_customer_analytics ...................... [RUN]
[0m17:13:30.304762 [info ] [Thread-2 (]: 2 of 3 START sql table model gold.gold_sales_by_category ....................... [RUN]
[0m17:13:30.305526 [info ] [Thread-3 (]: 3 of 3 START sql table model gold.gold_sales_by_country ........................ [RUN]
[0m17:13:30.306513 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_portifolio-482811_northwind_bronze, now model.northwind_dw.gold_customer_analytics)
[0m17:13:30.308159 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_portifolio-482811_northwind_silver, now model.northwind_dw.gold_sales_by_category)
[0m17:13:30.308804 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_portifolio-482811_gold, now model.northwind_dw.gold_sales_by_country)
[0m17:13:30.309226 [debug] [Thread-1 (]: Began compiling node model.northwind_dw.gold_customer_analytics
[0m17:13:30.309561 [debug] [Thread-2 (]: Began compiling node model.northwind_dw.gold_sales_by_category
[0m17:13:30.309876 [debug] [Thread-3 (]: Began compiling node model.northwind_dw.gold_sales_by_country
[0m17:13:30.314581 [debug] [Thread-1 (]: Writing injected SQL for node "model.northwind_dw.gold_customer_analytics"
[0m17:13:30.317083 [debug] [Thread-2 (]: Writing injected SQL for node "model.northwind_dw.gold_sales_by_category"
[0m17:13:30.319295 [debug] [Thread-3 (]: Writing injected SQL for node "model.northwind_dw.gold_sales_by_country"
[0m17:13:30.320575 [debug] [Thread-1 (]: Timing info for model.northwind_dw.gold_customer_analytics (compile): 17:13:30.310089 => 17:13:30.320164
[0m17:13:30.321442 [debug] [Thread-1 (]: Began executing node model.northwind_dw.gold_customer_analytics
[0m17:13:30.322175 [debug] [Thread-3 (]: Timing info for model.northwind_dw.gold_sales_by_country (compile): 17:13:30.317411 => 17:13:30.321842
[0m17:13:30.338867 [debug] [Thread-2 (]: Timing info for model.northwind_dw.gold_sales_by_category (compile): 17:13:30.314909 => 17:13:30.338483
[0m17:13:30.344944 [debug] [Thread-3 (]: Began executing node model.northwind_dw.gold_sales_by_country
[0m17:13:30.349081 [debug] [Thread-1 (]: Writing runtime sql for node "model.northwind_dw.gold_customer_analytics"
[0m17:13:30.349586 [debug] [Thread-2 (]: Began executing node model.northwind_dw.gold_sales_by_category
[0m17:13:30.351864 [debug] [Thread-3 (]: Writing runtime sql for node "model.northwind_dw.gold_sales_by_country"
[0m17:13:30.354698 [debug] [Thread-2 (]: Writing runtime sql for node "model.northwind_dw.gold_sales_by_category"
[0m17:13:30.355617 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:13:30.357125 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m17:13:30.358290 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m17:13:30.389922 [debug] [Thread-2 (]: On model.northwind_dw.gold_sales_by_category: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "node_id": "model.northwind_dw.gold_sales_by_category"} */

  
    

    create or replace table `portifolio-482811`.`gold`.`gold_sales_by_category`
      
    
    

    OPTIONS()
    as (
      -- Gold layer: Sales metrics by product category


WITH sales_by_category AS (
    SELECT
        p.category_id,
        p.category_name,
        p.category_name,
        COUNT(DISTINCT od.order_id) AS total_orders,
        COUNT(DISTINCT od.product_id) AS total_products,
        SUM(od.quantity) AS total_units_sold,
        SUM(od.unit_price * od.quantity * (1 - od.discount)) AS total_revenue,
        AVG(od.unit_price * od.quantity * (1 - od.discount)) AS avg_order_line_value,
        SUM(od.unit_price * od.quantity * od.discount) AS total_discounts
    FROM `portifolio-482811`.`northwind_bronze`.`bronze_order_details` od
    INNER JOIN `portifolio-482811`.`northwind_silver`.`silver_dim_products` p ON od.product_id = p.product_id
    GROUP BY p.category_id, p.category_name, p.category_name
)

SELECT
    category_id,
    category_name,
    category_description,
    total_orders,
    total_products,
    total_units_sold,
    ROUND(total_revenue, 2) AS total_revenue,
    ROUND(avg_order_line_value, 2) AS avg_order_line_value,
    ROUND(total_discounts, 2) AS total_discounts,
    ROUND(total_revenue / total_orders, 2) AS revenue_per_order,
    CURRENT_TIMESTAMP() AS updated_at
FROM sales_by_category
ORDER BY total_revenue DESC
    );
  
[0m17:13:30.390667 [debug] [Thread-1 (]: On model.northwind_dw.gold_customer_analytics: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "node_id": "model.northwind_dw.gold_customer_analytics"} */

  
    

    create or replace table `portifolio-482811`.`gold`.`gold_customer_analytics`
      
    
    

    OPTIONS()
    as (
      -- Gold layer: Customer analytics and segmentation


WITH customer_metrics AS (
    SELECT
        c.customer_id,
        c.company_name,
        c.contact_name,
        c.city,
        c.country,
        COUNT(DISTINCT o.order_id) AS total_orders,
        SUM(o.line_total) AS total_spent,
        AVG(o.line_total) AS avg_order_value,
        SUM(o.total_quantity) AS total_items_purchased,
        SUM(o.total_discount_amount) AS total_discounts_received,
        MIN(o.order_date) AS first_order_date,
        MAX(o.order_date) AS last_order_date,
        DATE_DIFF(CURRENT_DATE(), MAX(o.order_date), DAY) AS days_since_last_order
    FROM `portifolio-482811`.`northwind_silver`.`silver_dim_customers` c
    LEFT JOIN `portifolio-482811`.`northwind_silver`.`silver_fact_orders` o ON c.customer_id = o.customer_id
    GROUP BY 
        c.customer_id,
        c.company_name,
        c.contact_name,
        c.city,
        c.country
)

SELECT
    customer_id,
    company_name,
    contact_name,
    city,
    country,
    total_orders,
    ROUND(total_spent, 2) AS total_spent,
    ROUND(avg_order_value, 2) AS avg_order_value,
    total_items_purchased,
    ROUND(total_discounts_received, 2) AS total_discounts_received,
    first_order_date,
    last_order_date,
    days_since_last_order,
    -- Customer segmentation
    CASE 
        WHEN total_orders >= 10 THEN 'VIP'
        WHEN total_orders >= 5 THEN 'Frequent'
        WHEN total_orders >= 2 THEN 'Regular'
        ELSE 'New'
    END AS customer_segment,
    CASE 
        WHEN days_since_last_order <= 30 THEN 'Active'
        WHEN days_since_last_order <= 90 THEN 'At Risk'
        ELSE 'Inactive'
    END AS activity_status,
    CURRENT_TIMESTAMP() AS updated_at
FROM customer_metrics
ORDER BY total_spent DESC
    );
  
[0m17:13:30.391809 [debug] [Thread-3 (]: On model.northwind_dw.gold_sales_by_country: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "node_id": "model.northwind_dw.gold_sales_by_country"} */

  
    

    create or replace table `portifolio-482811`.`gold`.`gold_sales_by_country`
      
    
    

    OPTIONS()
    as (
      -- Gold layer: Sales metrics by country


WITH sales_by_country AS (
    SELECT
        c.country,
        COUNT(DISTINCT o.order_id) AS total_orders,
        COUNT(DISTINCT c.customer_id) AS total_customers,
        SUM(o.line_total) AS total_revenue,
        AVG(o.line_total) AS avg_order_value,
        SUM(o.total_quantity) AS total_units_sold,
        SUM(o.total_discount_amount) AS total_discounts,
        MIN(o.order_date) AS first_order_date,
        MAX(o.order_date) AS last_order_date
    FROM `portifolio-482811`.`northwind_silver`.`silver_fact_orders` o
    INNER JOIN `portifolio-482811`.`northwind_silver`.`silver_dim_customers` c ON o.customer_id = c.customer_id
    WHERE o.order_date IS NOT NULL
    GROUP BY c.country
)

SELECT
    country,
    total_orders,
    total_customers,
    ROUND(total_revenue, 2) AS total_revenue,
    ROUND(avg_order_value, 2) AS avg_order_value,
    total_units_sold,
    ROUND(total_discounts, 2) AS total_discounts,
    ROUND(total_revenue / total_customers, 2) AS revenue_per_customer,
    first_order_date,
    last_order_date,
    CURRENT_TIMESTAMP() AS updated_at
FROM sales_by_country
ORDER BY total_revenue DESC
    );
  
[0m17:13:31.519546 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:2e294577-b3af-419c-8361-4f2a67969cc7&page=queryresults
[0m17:13:31.552512 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:9bed5c4f-335b-4893-9f71-e95bb0eb6afb&page=queryresults
[0m17:13:31.999280 [debug] [Thread-2 (]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Column name category_name is ambiguous at [34:5]')
[0m17:13:32.022545 [debug] [Thread-3 (]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name total_quantity not found inside o at [23:15]')
[0m17:13:32.098677 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:84badac8-ec3b-44b0-ad9f-60de85ad0319&page=queryresults
[0m17:13:32.576719 [debug] [Thread-1 (]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Name total_quantity not found inside o at [26:15]')
[0m17:13:32.796119 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:5f4a1a0e-5a03-45fa-bb79-218b174aa509&page=queryresults
[0m17:13:33.378901 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:5f4a1a0e-5a03-45fa-bb79-218b174aa509&page=queryresults
[0m17:13:33.380171 [debug] [Thread-2 (]: Timing info for model.northwind_dw.gold_sales_by_category (execute): 17:13:30.352536 => 17:13:33.379829
[0m17:13:33.386972 [debug] [Thread-2 (]: Database Error in model gold_sales_by_category (models/gold/gold_sales_by_category.sql)
  Column name category_name is ambiguous at [34:5]
  compiled Code at target/run/northwind_dw/models/gold/gold_sales_by_category.sql
[0m17:13:33.387567 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bc133c50>]}
[0m17:13:33.388145 [error] [Thread-2 (]: 2 of 3 ERROR creating sql table model gold.gold_sales_by_category .............. [[31mERROR[0m in 3.08s]
[0m17:13:33.388600 [debug] [Thread-2 (]: Finished running node model.northwind_dw.gold_sales_by_category
[0m17:13:33.474234 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:cb255d63-20c3-44f5-a453-a7c534f258a6&page=queryresults
[0m17:13:33.857709 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:d8e0b26c-9e43-4b25-a46c-f2036d136d27&page=queryresults
[0m17:13:33.999164 [error] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:cb255d63-20c3-44f5-a453-a7c534f258a6&page=queryresults
[0m17:13:34.000192 [debug] [Thread-3 (]: Timing info for model.northwind_dw.gold_sales_by_country (execute): 17:13:30.349867 => 17:13:33.999879
[0m17:13:34.002677 [debug] [Thread-3 (]: Database Error in model gold_sales_by_country (models/gold/gold_sales_by_country.sql)
  Name total_quantity not found inside o at [23:15]
  compiled Code at target/run/northwind_dw/models/gold/gold_sales_by_country.sql
[0m17:13:34.003107 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86b7112190>]}
[0m17:13:34.003569 [error] [Thread-3 (]: 3 of 3 ERROR creating sql table model gold.gold_sales_by_country ............... [[31mERROR[0m in 3.69s]
[0m17:13:34.004008 [debug] [Thread-3 (]: Finished running node model.northwind_dw.gold_sales_by_country
[0m17:13:34.355566 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:d8e0b26c-9e43-4b25-a46c-f2036d136d27&page=queryresults
[0m17:13:34.357029 [debug] [Thread-1 (]: Timing info for model.northwind_dw.gold_customer_analytics (execute): 17:13:30.322559 => 17:13:34.356562
[0m17:13:34.361562 [debug] [Thread-1 (]: Database Error in model gold_customer_analytics (models/gold/gold_customer_analytics.sql)
  Name total_quantity not found inside o at [26:15]
  compiled Code at target/run/northwind_dw/models/gold/gold_customer_analytics.sql
[0m17:13:34.362322 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03d47351-58e0-4bf8-88ed-fc7580df30a1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bdcbc150>]}
[0m17:13:34.363086 [error] [Thread-1 (]: 1 of 3 ERROR creating sql table model gold.gold_customer_analytics ............. [[31mERROR[0m in 4.06s]
[0m17:13:34.363817 [debug] [Thread-1 (]: Finished running node model.northwind_dw.gold_customer_analytics
[0m17:13:34.366496 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:13:34.366805 [debug] [MainThread]: Connection 'model.northwind_dw.gold_sales_by_country' was properly closed.
[0m17:13:34.367127 [debug] [MainThread]: Connection 'list_portifolio-482811_northwind_gold' was properly closed.
[0m17:13:34.367335 [debug] [MainThread]: Connection 'model.northwind_dw.gold_customer_analytics' was properly closed.
[0m17:13:34.367548 [debug] [MainThread]: Connection 'model.northwind_dw.gold_sales_by_category' was properly closed.
[0m17:13:34.367796 [info ] [MainThread]: 
[0m17:13:34.368066 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 5.99 seconds (5.99s).
[0m17:13:34.368634 [debug] [MainThread]: Command end result
[0m17:13:34.449020 [info ] [MainThread]: 
[0m17:13:34.449447 [info ] [MainThread]: [31mCompleted with 3 errors and 0 warnings:[0m
[0m17:13:34.449737 [info ] [MainThread]: 
[0m17:13:34.450013 [error] [MainThread]:   Database Error in model gold_sales_by_category (models/gold/gold_sales_by_category.sql)
  Column name category_name is ambiguous at [34:5]
  compiled Code at target/run/northwind_dw/models/gold/gold_sales_by_category.sql
[0m17:13:34.450268 [info ] [MainThread]: 
[0m17:13:34.450510 [error] [MainThread]:   Database Error in model gold_sales_by_country (models/gold/gold_sales_by_country.sql)
  Name total_quantity not found inside o at [23:15]
  compiled Code at target/run/northwind_dw/models/gold/gold_sales_by_country.sql
[0m17:13:34.451294 [info ] [MainThread]: 
[0m17:13:34.451771 [error] [MainThread]:   Database Error in model gold_customer_analytics (models/gold/gold_customer_analytics.sql)
  Name total_quantity not found inside o at [26:15]
  compiled Code at target/run/northwind_dw/models/gold/gold_customer_analytics.sql
[0m17:13:34.452266 [info ] [MainThread]: 
[0m17:13:34.452882 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=3 SKIP=0 TOTAL=3
[0m17:13:34.453654 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 7.097759, "process_user_time": 3.910829, "process_kernel_time": 1.616013, "process_mem_max_rss": "243672", "process_out_blocks": "4224", "command_success": false, "process_in_blocks": "0"}
[0m17:13:34.454048 [debug] [MainThread]: Command `dbt run` failed at 17:13:34.453954 after 7.10 seconds
[0m17:13:34.454328 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bdb907d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bdb93510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7b86bdb93dd0>]}
[0m17:13:34.454619 [debug] [MainThread]: Flushing usage events
[0m17:18:45.326191 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c949369e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c949368890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c949368350>]}


============================== 17:18:45.330502 | e97ead2b-34c8-4ba7-9928-b0993041c888 ==============================
[0m17:18:45.330502 [info ] [MainThread]: Running with dbt=1.7.4
[0m17:18:45.330963 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'debug': 'False', 'version_check': 'True', 'log_path': '/opt/airflow/dbt/northwind_dw/logs', 'fail_fast': 'False', 'profiles_dir': '/opt/airflow/dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select gold_customer_analytics gold_sales_by_country gold_sales_by_category --profiles-dir /opt/airflow/dbt --full-refresh', 'log_format': 'default', 'static_parser': 'True', 'target_path': 'None', 'introspect': 'True', 'send_anonymous_usage_stats': 'True'}
[0m17:18:46.073430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c909851e90>]}
[0m17:18:46.140005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c909cee8d0>]}
[0m17:18:46.140807 [info ] [MainThread]: Registered adapter: bigquery=1.7.2
[0m17:18:46.149192 [debug] [MainThread]: checksum: 248e8aba381ba2d577dce7ab50d2010c2aac45d2b27e6e6214cdd96d2d41fabc, vars: {}, profile: , target: , version: 1.7.4
[0m17:18:46.176430 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m17:18:46.177033 [debug] [MainThread]: Partial parsing: updated file: northwind_dw://models/gold/gold_sales_by_category.sql
[0m17:18:46.177375 [debug] [MainThread]: Partial parsing: updated file: northwind_dw://models/gold/gold_customer_analytics.sql
[0m17:18:46.177669 [debug] [MainThread]: Partial parsing: updated file: northwind_dw://models/gold/gold_sales_by_country.sql
[0m17:18:46.312701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c9094cc690>]}
[0m17:18:46.326614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c909512210>]}
[0m17:18:46.327047 [info ] [MainThread]: Found 20 models, 22 tests, 8 sources, 0 exposures, 0 metrics, 562 macros, 0 groups, 0 semantic models
[0m17:18:46.327392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c9098d09d0>]}
[0m17:18:46.329008 [info ] [MainThread]: 
[0m17:18:46.329667 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:18:46.330810 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811'
[0m17:18:46.331337 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:18:47.540475 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_portifolio-482811, now create_portifolio-482811_gold)
[0m17:18:47.541174 [debug] [ThreadPool]: Creating schema "database: "portifolio-482811"
schema: "gold"
"
[0m17:18:47.547984 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:18:47.576709 [debug] [ThreadPool]: On create_portifolio-482811_gold: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "connection_name": "create_portifolio-482811_gold"} */
create schema if not exists `portifolio-482811`.`gold`
  
[0m17:18:48.445884 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:7bd5e481-03af-4e8f-8a0b-96ac9bd1780b&page=queryresults
[0m17:18:49.221134 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_portifolio-482811_gold, now list_portifolio-482811_gold)
[0m17:18:49.222045 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_gold'
[0m17:18:49.223056 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_silver'
[0m17:18:49.223418 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:18:49.224365 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_portifolio-482811_northwind_bronze'
[0m17:18:49.224711 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:18:49.225143 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:18:49.225729 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:18:50.214729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c909493250>]}
[0m17:18:50.216609 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m17:18:50.217455 [info ] [MainThread]: 
[0m17:18:50.226977 [debug] [Thread-1 (]: Began running node model.northwind_dw.gold_customer_analytics
[0m17:18:50.227405 [debug] [Thread-2 (]: Began running node model.northwind_dw.gold_sales_by_category
[0m17:18:50.227855 [debug] [Thread-3 (]: Began running node model.northwind_dw.gold_sales_by_country
[0m17:18:50.228268 [info ] [Thread-1 (]: 1 of 3 START sql table model gold.gold_customer_analytics ...................... [RUN]
[0m17:18:50.228787 [info ] [Thread-2 (]: 2 of 3 START sql table model gold.gold_sales_by_category ....................... [RUN]
[0m17:18:50.229904 [info ] [Thread-3 (]: 3 of 3 START sql table model gold.gold_sales_by_country ........................ [RUN]
[0m17:18:50.231416 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_portifolio-482811_northwind_gold, now model.northwind_dw.gold_customer_analytics)
[0m17:18:50.232338 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_portifolio-482811_northwind_silver, now model.northwind_dw.gold_sales_by_category)
[0m17:18:50.233054 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_portifolio-482811_gold, now model.northwind_dw.gold_sales_by_country)
[0m17:18:50.233508 [debug] [Thread-1 (]: Began compiling node model.northwind_dw.gold_customer_analytics
[0m17:18:50.233857 [debug] [Thread-2 (]: Began compiling node model.northwind_dw.gold_sales_by_category
[0m17:18:50.234168 [debug] [Thread-3 (]: Began compiling node model.northwind_dw.gold_sales_by_country
[0m17:18:50.239524 [debug] [Thread-1 (]: Writing injected SQL for node "model.northwind_dw.gold_customer_analytics"
[0m17:18:50.242362 [debug] [Thread-2 (]: Writing injected SQL for node "model.northwind_dw.gold_sales_by_category"
[0m17:18:50.245044 [debug] [Thread-3 (]: Writing injected SQL for node "model.northwind_dw.gold_sales_by_country"
[0m17:18:50.246163 [debug] [Thread-1 (]: Timing info for model.northwind_dw.gold_customer_analytics (compile): 17:18:50.234386 => 17:18:50.245868
[0m17:18:50.246755 [debug] [Thread-2 (]: Timing info for model.northwind_dw.gold_sales_by_category (compile): 17:18:50.239975 => 17:18:50.246502
[0m17:18:50.247218 [debug] [Thread-1 (]: Began executing node model.northwind_dw.gold_customer_analytics
[0m17:18:50.247674 [debug] [Thread-2 (]: Began executing node model.northwind_dw.gold_sales_by_category
[0m17:18:50.258876 [debug] [Thread-3 (]: Timing info for model.northwind_dw.gold_sales_by_country (compile): 17:18:50.242768 => 17:18:50.258633
[0m17:18:50.270450 [debug] [Thread-1 (]: Writing runtime sql for node "model.northwind_dw.gold_customer_analytics"
[0m17:18:50.272618 [debug] [Thread-2 (]: Writing runtime sql for node "model.northwind_dw.gold_sales_by_category"
[0m17:18:50.273036 [debug] [Thread-3 (]: Began executing node model.northwind_dw.gold_sales_by_country
[0m17:18:50.275327 [debug] [Thread-3 (]: Writing runtime sql for node "model.northwind_dw.gold_sales_by_country"
[0m17:18:50.275946 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:18:50.276392 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m17:18:50.277075 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m17:18:50.305783 [debug] [Thread-3 (]: On model.northwind_dw.gold_sales_by_country: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "node_id": "model.northwind_dw.gold_sales_by_country"} */

  
    

    create or replace table `portifolio-482811`.`gold`.`gold_sales_by_country`
      
    
    

    OPTIONS()
    as (
      -- Gold layer: Sales metrics by country


WITH sales_by_country AS (
    SELECT
        c.country,
        COUNT(DISTINCT o.order_id) AS total_orders,
        COUNT(DISTINCT c.customer_id) AS total_customers,
        SUM(o.line_total) AS total_revenue,
        AVG(o.line_total) AS avg_order_value,
        SUM(o.quantity) AS total_units_sold,
        SUM(o.line_total * o.discount / (1 - o.discount)) AS total_discounts,
        MIN(o.order_date) AS first_order_date,
        MAX(o.order_date) AS last_order_date
    FROM `portifolio-482811`.`northwind_silver`.`silver_fact_orders` o
    INNER JOIN `portifolio-482811`.`northwind_silver`.`silver_dim_customers` c ON o.customer_id = c.customer_id
    WHERE o.order_date IS NOT NULL
    GROUP BY c.country
)

SELECT
    country,
    total_orders,
    total_customers,
    ROUND(total_revenue, 2) AS total_revenue,
    ROUND(avg_order_value, 2) AS avg_order_value,
    total_units_sold,
    ROUND(total_discounts, 2) AS total_discounts,
    ROUND(total_revenue / total_customers, 2) AS revenue_per_customer,
    first_order_date,
    last_order_date,
    CURRENT_TIMESTAMP() AS updated_at
FROM sales_by_country
ORDER BY total_revenue DESC
    );
  
[0m17:18:50.306679 [debug] [Thread-1 (]: On model.northwind_dw.gold_customer_analytics: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "node_id": "model.northwind_dw.gold_customer_analytics"} */

  
    

    create or replace table `portifolio-482811`.`gold`.`gold_customer_analytics`
      
    
    

    OPTIONS()
    as (
      -- Gold layer: Customer analytics and segmentation


WITH customer_metrics AS (
    SELECT
        c.customer_id,
        c.company_name,
        c.contact_name,
        c.city,
        c.country,
        COUNT(DISTINCT o.order_id) AS total_orders,
        SUM(o.line_total) AS total_spent,
        AVG(o.line_total) AS avg_order_value,
        SUM(o.quantity) AS total_items_purchased,
        SUM(o.line_total * o.discount / (1 - o.discount)) AS total_discounts_received,
        MIN(o.order_date) AS first_order_date,
        MAX(o.order_date) AS last_order_date,
        DATE_DIFF(CURRENT_DATE(), MAX(o.order_date), DAY) AS days_since_last_order
    FROM `portifolio-482811`.`northwind_silver`.`silver_dim_customers` c
    LEFT JOIN `portifolio-482811`.`northwind_silver`.`silver_fact_orders` o ON c.customer_id = o.customer_id
    GROUP BY 
        c.customer_id,
        c.company_name,
        c.contact_name,
        c.city,
        c.country
)

SELECT
    customer_id,
    company_name,
    contact_name,
    city,
    country,
    total_orders,
    ROUND(total_spent, 2) AS total_spent,
    ROUND(avg_order_value, 2) AS avg_order_value,
    total_items_purchased,
    ROUND(total_discounts_received, 2) AS total_discounts_received,
    first_order_date,
    last_order_date,
    days_since_last_order,
    -- Customer segmentation
    CASE 
        WHEN total_orders >= 10 THEN 'VIP'
        WHEN total_orders >= 5 THEN 'Frequent'
        WHEN total_orders >= 2 THEN 'Regular'
        ELSE 'New'
    END AS customer_segment,
    CASE 
        WHEN days_since_last_order <= 30 THEN 'Active'
        WHEN days_since_last_order <= 90 THEN 'At Risk'
        ELSE 'Inactive'
    END AS activity_status,
    CURRENT_TIMESTAMP() AS updated_at
FROM customer_metrics
ORDER BY total_spent DESC
    );
  
[0m17:18:50.307212 [debug] [Thread-2 (]: On model.northwind_dw.gold_sales_by_category: /* {"app": "dbt", "dbt_version": "1.7.4", "profile_name": "northwind_dw", "target_name": "dev", "node_id": "model.northwind_dw.gold_sales_by_category"} */

  
    

    create or replace table `portifolio-482811`.`gold`.`gold_sales_by_category`
      
    
    

    OPTIONS()
    as (
      -- Gold layer: Sales metrics by product category


WITH sales_by_category AS (
    SELECT
        p.category_id,
        p.category_name,
        COUNT(DISTINCT od.order_id) AS total_orders,
        COUNT(DISTINCT od.product_id) AS total_products,
        SUM(od.quantity) AS total_units_sold,
        SUM(od.unit_price * od.quantity * (1 - od.discount)) AS total_revenue,
        AVG(od.unit_price * od.quantity * (1 - od.discount)) AS avg_order_line_value,
        SUM(od.unit_price * od.quantity * od.discount) AS total_discounts
    FROM `portifolio-482811`.`northwind_bronze`.`bronze_order_details` od
    INNER JOIN `portifolio-482811`.`northwind_silver`.`silver_dim_products` p ON od.product_id = p.product_id
    GROUP BY p.category_id, p.category_name
)

SELECT
    category_id,
    category_name,
    category_name AS category_description,
    total_orders,
    total_products,
    total_units_sold,
    ROUND(total_revenue, 2) AS total_revenue,
    ROUND(avg_order_line_value, 2) AS avg_order_line_value,
    ROUND(total_discounts, 2) AS total_discounts,
    ROUND(total_revenue / total_orders, 2) AS revenue_per_order,
    CURRENT_TIMESTAMP() AS updated_at
FROM sales_by_category
ORDER BY total_revenue DESC
    );
  
[0m17:18:51.435246 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:7aec3598-a2de-4c3a-8e63-2d1d7644fa7e&page=queryresults
[0m17:18:51.481537 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:fce815db-e2c0-45c9-b501-de2225c92ea6&page=queryresults
[0m17:18:51.569344 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=portifolio-482811&j=bq:US:5ca93c1a-5edc-4820-8af4-6f1c3a80f27d&page=queryresults
[0m17:18:53.623081 [debug] [Thread-3 (]: Timing info for model.northwind_dw.gold_sales_by_country (execute): 17:18:50.273631 => 17:18:53.622896
[0m17:18:53.623748 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c90945f390>]}
[0m17:18:53.624264 [info ] [Thread-3 (]: 3 of 3 OK created sql table model gold.gold_sales_by_country ................... [[32mCREATE TABLE (4.0 rows, 765.0 Bytes processed)[0m in 3.39s]
[0m17:18:53.624747 [debug] [Thread-3 (]: Finished running node model.northwind_dw.gold_sales_by_country
[0m17:18:53.683179 [debug] [Thread-2 (]: Timing info for model.northwind_dw.gold_sales_by_category (execute): 17:18:50.270782 => 17:18:53.682785
[0m17:18:53.684454 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c8e2979a50>]}
[0m17:18:53.685287 [info ] [Thread-2 (]: 2 of 3 OK created sql table model gold.gold_sales_by_category .................. [[32mCREATE TABLE (4.0 rows, 714.0 Bytes processed)[0m in 3.45s]
[0m17:18:53.685977 [debug] [Thread-2 (]: Finished running node model.northwind_dw.gold_sales_by_category
[0m17:18:53.713954 [debug] [Thread-1 (]: Timing info for model.northwind_dw.gold_customer_analytics (execute): 17:18:50.247940 => 17:18:53.713612
[0m17:18:53.714813 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e97ead2b-34c8-4ba7-9928-b0993041c888', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c909713d10>]}
[0m17:18:53.715471 [info ] [Thread-1 (]: 1 of 3 OK created sql table model gold.gold_customer_analytics ................. [[32mCREATE TABLE (5.0 rows, 1016.0 Bytes processed)[0m in 3.48s]
[0m17:18:53.716102 [debug] [Thread-1 (]: Finished running node model.northwind_dw.gold_customer_analytics
[0m17:18:53.718657 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:18:53.719024 [debug] [MainThread]: Connection 'model.northwind_dw.gold_sales_by_country' was properly closed.
[0m17:18:53.719337 [debug] [MainThread]: Connection 'model.northwind_dw.gold_customer_analytics' was properly closed.
[0m17:18:53.719612 [debug] [MainThread]: Connection 'model.northwind_dw.gold_sales_by_category' was properly closed.
[0m17:18:53.719906 [debug] [MainThread]: Connection 'list_portifolio-482811_northwind_bronze' was properly closed.
[0m17:18:53.720270 [info ] [MainThread]: 
[0m17:18:53.720641 [info ] [MainThread]: Finished running 3 table models in 0 hours 0 minutes and 7.39 seconds (7.39s).
[0m17:18:53.721382 [debug] [MainThread]: Command end result
[0m17:18:53.799348 [info ] [MainThread]: 
[0m17:18:53.799757 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:18:53.800096 [info ] [MainThread]: 
[0m17:18:53.800434 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
[0m17:18:53.801129 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 8.501901, "process_user_time": 3.760726, "process_kernel_time": 1.689433, "process_mem_max_rss": "244456", "process_out_blocks": "4216", "process_in_blocks": "0"}
[0m17:18:53.801539 [debug] [MainThread]: Command `dbt run` succeeded at 17:18:53.801430 after 8.50 seconds
[0m17:18:53.801833 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c949e93b90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c94e2398d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x74c94e109d50>]}
[0m17:18:53.802121 [debug] [MainThread]: Flushing usage events
